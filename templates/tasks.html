{% extends "layout.html" %}
{% block title %}Tasks{% endblock %}

{% block content %}
<div class="content-card">
    <h3>Tasks</h3>

    <!-- ===== Create Task Form ===== -->
    <div class="card mb-4 p-3">
        <h5>Create Task</h5>
        <form method="POST" action="{{ url_for('tasks.tasks_page') }}">
            {{ form.hidden_tag() }}
            <div class="row g-2">
                <div class="col-md-3">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control") }}
                </div>
                <div class="col-md-3">
                    {{ form.description.label(class="form-label") }}
                    {{ form.description(class="form-control") }}
                </div>
                <div class="col-md-2">
                    {{ form.assigned_to.label(class="form-label") }}
                    {{ form.assigned_to(class="form-select") }}
                </div>
                <div class="col-md-2">
                    {{ form.priority.label(class="form-label") }}
                    {{ form.priority(class="form-select") }}
                </div>
                <div class="col-md-2">
                    {{ form.status.label(class="form-label") }}
                    {{ form.status(class="form-select") }}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-3">
                    {{ form.due_date.label(class="form-label") }}
                    {{ form.due_date(class="form-control") }}
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </div>
        </form>
    </div>

    <!-- ===== Filter Tasks ===== -->
    <form method="GET" class="mb-3">
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" name="q" class="form-control" placeholder="Search by title" value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    <option value="Pending" {% if status_filter=='Pending' %}selected{% endif %}>Pending</option>
                    <option value="In Progress" {% if status_filter=='In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Completed" {% if status_filter=='Completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            <div class="col-md-3">
                <select name="priority" class="form-select">
                    <option value="">All Priority</option>
                    <option value="Low" {% if priority_filter=='Low' %}selected{% endif %}>Low</option>
                    <option value="Medium" {% if priority_filter=='Medium' %}selected{% endif %}>Medium</option>
                    <option value="High" {% if priority_filter=='High' %}selected{% endif %}>High</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary w-100">Filter</button>
            </div>
        </div>
    </form>

    <!-- ===== Task List ===== -->
    <table class="table table-striped">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Assigned To</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr {% if task.due_date and task.due_date < today and task.status != 'Completed' %}class="table-danger"{% endif %}>
                <td>{{ task.title }}</td>
                <td>{{ task.description }}</td>
                <td>{{ task.assigned_to }}</td>
                <td>{{ task.priority }}</td>
                <td>{{ task.status }}</td>
                <td>{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}</td>
                <td>
                    <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="btn btn-sm btn-warning">Edit</a>
                    <form method="POST" action="{{ url_for('tasks.delete_task', task_id=task.id) }}" style="display:inline;">
                        {{ form.csrf_token }}
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                    {% if task.status != 'Completed' %}
                    <form method="POST" action="{{ url_for('tasks.complete_task', task_id=task.id) }}" style="display:inline;">
                        {{ form.csrf_token }}
                        <button type="submit" class="btn btn-sm btn-success">Complete</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center">No tasks found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
